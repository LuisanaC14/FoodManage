{% extends "admin/change_list.html" %}
{% load static %}

{% block extrahead %}
    {{ block.super }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        #content-main { max-width: 98% !important; }
        .dashboard-container { display: flex; flex-direction: column; gap: 25px; margin-top: 15px; }

        /* T√çTULOS */
        .section-title {
            color: #888; font-size: 0.9rem; font-weight: bold; text-transform: uppercase;
            border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 15px;
            display: flex; align-items: center; gap: 10px;
        }

        /* TARJETAS SUPERIORES */
        .financial-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .card-finanza { 
            background: #0a0a0a; border-radius: 12px; padding: 20px; text-align: center; 
            border: 1px solid #222; box-shadow: 0 8px 25px rgba(0,0,0,0.5);
        }
        .card-finanza h3 { font-size: 0.75rem; color: #aaa; text-transform: uppercase; margin-bottom: 5px; }
        .card-finanza .monto { font-size: 2rem; font-weight: 900; font-family: monospace; }
        
        .color-ingreso { color: #ccff00; border-top: 3px solid #ccff00; }
        .color-gasto { color: #ff4d4d; border-top: 3px solid #ff4d4d; }
        .color-neutro { color: #d63384; border-top: 3px solid #d63384; }
        .color-info { color: #00eaff; border-top: 3px solid #00eaff; }

        /* ARQUEO DE CAJA */
        .arqueo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card-arqueo {
            background: #111; border-radius: 12px; padding: 20px;
            display: flex; justify-content: space-between; align-items: center;
            border: 1px dashed #444;
        }
        .card-arqueo.fisico { background: rgba(204, 255, 0, 0.05); border: 1px solid #ccff00; }
        .card-arqueo.banco { background: rgba(0, 234, 255, 0.05); border: 1px solid #00eaff; }

        /* ESTRUCTURA PRINCIPAL (TABLAS Y GR√ÅFICAS) */
        .main-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        
        .panel-box { background: #1a1a1a; border-radius: 12px; border: 1px solid #333; overflow: hidden; margin-bottom: 20px; }
        .panel-header { padding:15px; background:#111; font-weight:bold; color:#fff; border-bottom:1px solid #333; }
        .table-dark { width: 100%; color: #ddd; border-collapse: collapse; }
        .table-dark td { padding: 12px; border-bottom: 1px solid #333; font-size: 0.9rem; }

        /* BOTONES Y MODALES */
        .btn-custom { padding: 10px 20px; border-radius: 8px; font-weight: bold; text-decoration: none; display: inline-block; cursor: pointer; border:none; }
        .btn-green { background: #ccff00; color: #000; }
        .btn-red { background: #ff4d4d; color: #fff; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: none; justify-content: center; align-items: center; }
        .modal-box { background: #111; border: 1px solid #444; padding: 30px; width: 400px; border-radius: 12px; text-align: center; }
        .modal-box input { width: 100%; padding: 15px; margin-bottom: 20px; background: #222; border: 1px solid #555; color: #fff; text-align: center; font-size: 1.5rem; border-radius: 8px; }
    
    /* =========================================
       RESPONSIVIDAD DASHBOARD VENTAS (COMPACTO)
       ========================================= */
    @media (max-width: 992px) {
        
        /* 1. Cabecera Flexible */
        .dashboard-container > div:first-child {
            flex-direction: column !important;
            padding: 10px !important;
        }

        /* 2. Tarjetas de Resumen (Fondo, Ventas, Gastos, Utilidad) */
        .financial-grid {
            grid-template-columns: repeat(2, 1fr) !important;
            gap: 10px !important;
        }
        .card-finanza { padding: 12px !important; }
        .card-finanza .monto { font-size: 1.2rem !important; }

        /* 3. ARQUEO DE CAJA: AJUSTE DE PRECISI√ìN */
        .arqueo-grid {
            grid-template-columns: 1fr 1fr !important; /* Lado a lado */
            gap: 8px !important;
            margin: 0 -5px !important; /* Aprovecha los bordes */
        }
        
        .card-arqueo {
            flex-direction: column !important;
            align-items: center !important;
            text-align: center !important;
            padding: 10px 5px !important; /* Relleno m√≠nimo */
            min-height: 180px !important;
            justify-content: center !important;
        }

        /* T√≠tulos de las tarjetas (Efectivo / Banco) */
        .card-arqueo h4 { 
            font-size: 0.65rem !important; 
            letter-spacing: 0 !important;
            white-space: nowrap;
        }

        /* Cifras de dinero ($1375,00) */
        .card-arqueo div[style*="font-size: 2.5rem"] { 
            font-size: 1.25rem !important; /* Tama√±o reducido para que no se corte */
            margin: 8px 0 !important;
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Etiquetas secundarias (Entr√≥/Sali√≥) */
        .card-arqueo p, 
        .card-arqueo div[style*="text-align: right"] { 
            font-size: 0.6rem !important; 
            line-height: 1.2 !important;
            text-align: center !important;
            width: 100%;
        }

        /* Icono del banco */
        .card-arqueo i.fa-university { 
            font-size: 1.8rem !important; 
            margin-top: 5px;
            opacity: 0.2;
        }

        /* Reducimos los textos gigantes para que quepan */
        .card-arqueo h4 { font-size: 0.7rem !important; }
        .card-arqueo div[style*="font-size: 2.5rem"] { 
            font-size: 1.4rem !important; 
            margin: 5px 0 !important;
        }
        .card-arqueo p, .card-arqueo div[style*="text-align: right"] { 
            font-size: 0.65rem !important; 
            text-align: center !important;
        }
        .card-arqueo i { font-size: 2rem !important; margin-top: 10px; }

        /* 4. Tablas y Gr√°fica */
        .main-grid { grid-template-columns: 1fr !important; }
    }

    @media (max-width: 576px) {
        /* Ajuste extremo para celulares peque√±os */
        .card-arqueo { min-height: 160px; justify-content: center; }
        .card-arqueo div[style*="font-size: 2.5rem"] { font-size: 1.2rem !important; }
    }
    @media (max-width: 992px) {
        /* Contenedor de botones de acci√≥n */
        .dashboard-container > div:first-child > div:last-child {
            display: grid !important;
            grid-template-columns: repeat(3, 1fr) !important; /* Forzamos 3 columnas */
            gap: 8px !important; /* Espacio uniforme entre ellos */
            width: 100% !important;
            padding: 5px 0 !important;
        }

        /* Reducci√≥n sutil de los botones */
        .dashboard-container .btn-custom {
            padding: 8px 5px !important; /* Menos relleno interno */
            font-size: 0.75rem !important; /* Letra un poco m√°s peque√±a */
            display: flex !important;
            flex-direction: column !important; /* Icono arriba, texto abajo */
            align-items: center !important;
            justify-content: center !important;
            min-height: 60px !important; /* Altura uniforme */
            border-radius: 10px !important;
        }

        .dashboard-container .btn-custom i {
            margin-bottom: 4px !important;
            font-size: 1rem !important;
        }

        /* Ajuste espec√≠fico para el bot√≥n de Cerrar Turno (texto largo) */
        .btn-red {
            line-height: 1 !important;
            text-align: center !important;
        }
    }
    </style>
{% endblock %}

{% block content %}
<div class="dashboard-container">

    <div style="display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; padding: 15px; border-radius: 12px; border: 1px solid #333;">
        
        <div style="display: flex; align-items: center; gap: 15px;">
            {% if caja_abierta %}
                <span style="background: #ccff00; color: #000; padding: 8px 12px; border-radius: 6px; font-weight: bold;">üü¢ CAJA ABIERTA</span>
            {% else %}
                <button onclick="document.getElementById('modal-apertura').style.display='flex'" class="btn-custom btn-green">ABRIR CAJA</button>
            {% endif %}
            
            <h2 style="color: #888; margin: 0; font-size: 1rem; border-left: 1px solid #444; padding-left: 15px;">
                {{ title }}
            </h2>
        </div>

        <div style="display: flex; gap: 10px;">
            {% if caja_abierta %}
                <button onclick="window.open('{% url 'admin:venta_imprimir' %}', 'ReportePrint', 'width=900,height=800,scrollbars=yes'); return false;" 
                        class="btn-custom" style="background:#00eaff; color:#000;">
                    <i class="fas fa-print"></i> Reporte
                </button>

                <a href="{% url 'admin:venta_excel' %}" class="btn-custom" style="background:#1D6F42; color:#fff;">
                    <i class="fas fa-file-excel"></i> Excel
                </a>

                <form action="{% url 'admin:venta_cerrar_caja' %}" method="POST" onsubmit="return confirm('¬øCerrar turno?');" style="margin:0;">
                    {% csrf_token %}
                    <button type="submit" class="btn-custom btn-red">CERRAR TURNO</button>
                </form>
            {% endif %}
        </div>
    </div> 

    <div class="financial-grid">
        <div class="card-finanza color-neutro">
            <h3>Fondo Inicial</h3>
            <div class="monto">${{ monto_inicial }}</div>
        </div>
        <div class="card-finanza color-ingreso">
            <h3>Total Ventas</h3>
            <div class="monto">+${{ total_ingresos }}</div>
        </div>
        <div class="card-finanza color-gasto">
            <h3>Total Gastos</h3>
            <div class="monto">-${{ total_gastos }}</div>
        </div>
        <div class="card-finanza color-info">
            <h3>Utilidad Neta</h3>
            <div class="monto">${{ utilidad_neta }}</div>
        </div>
    </div>

    <div class="arqueo-grid">
        <div class="card-arqueo fisico">
            <div>
                <h4 style="color: #ccff00; margin: 0;">üíµ EFECTIVO EN GAVETA</h4>
                <p style="color: #888; font-size: 0.8rem;">(Fondo + Ventas Efectivo - Gastos)</p>
                <div style="font-size: 2.5rem; font-weight: 900; color: #fff;">${{ dinero_en_caja }}</div>
            </div>
            <div style="text-align: right; color: #ccff00;">
                <div>Entr√≥: +${{ total_efectivo }}</div>
                <div style="color:#ff4d4d;">Sali√≥: -${{ total_gastos }}</div>
            </div>
        </div>

        <div class="card-arqueo banco">
            <div>
                <h4 style="color: #00eaff; margin: 0;">üè¶ DINERO EN BANCO</h4>
                <div style="font-size: 2.5rem; font-weight: 900; color: #fff;">${{ total_transferencia }}</div>
            </div>
            <i class="fas fa-university" style="font-size: 3rem; color: #00eaff; opacity: 0.3;"></i>
        </div>
    </div>

    <div class="main-grid">
        <div class="left-col">
            <div class="panel-box">
                <div class="panel-header" style="border-left: 4px solid #ccff00;">üõí √öLTIMAS VENTAS</div>
                <table class="table-dark">
                    {% for v in todas_ventas|slice:":5" %}
                    <tr>
                        <td>{{ v.fecha_venta|time:"H:i" }}</td>
                        <td>{{ v.producto.nombre }}</td>
                        <td>
                            {% if v.metodo_pago == 'Efectivo' %}
                                <span class="badge" style="color:#ccff00; font-weight:bold;">EFECTIVO</span>
                            {% else %}
                                <span class="badge" style="color:#00eaff; font-weight:bold;">BANCO</span>
                            {% endif %}
                        </td>
                        <td style="text-align:right; color:#ccff00;">${{ v.total }}</td>
                    </tr>
                    {% empty %}<tr><td colspan="4" class="text-center p-3">Sin ventas hoy</td></tr>{% endfor %}
                </table>
            </div>

            <div class="panel-box">
                <div class="panel-header" style="border-left: 4px solid #ff4d4d;">
                    <span>üìâ GASTOS OPERATIVOS</span>
                    {% if caja_abierta %}<button onclick="document.getElementById('modal-gasto').style.display='flex'" style="float:right; background:none; border:1px solid #ff4d4d; color:#ff4d4d; border-radius:4px; font-size:0.7rem; cursor:pointer;">+ NUEVO</button>{% endif %}
                </div>
                <table class="table-dark">
                    {% for g in todos_gastos %}
                    <tr>
                        <td>{{ g.fecha|time:"H:i" }}</td>
                        <td>{{ g.concepto }}</td>
                        <td style="text-align:right; color:#ff4d4d;">-${{ g.monto }}</td>
                    </tr>
                    {% empty %}<tr><td colspan="3" class="text-center p-3">Sin gastos hoy</td></tr>{% endfor %}
                </table>
            </div>
        </div>

        <div class="right-col">
            <div class="panel-box" style="padding: 20px;">
                <h4 style="color:#888; margin:0 0 15px 0; font-size:0.8rem;">üìä VENTA POR HORA</h4>
                <div style="height: 200px;"><canvas id="ventasChart"></canvas></div>
            </div>
            
            <div class="panel-box">
                <div class="panel-header" style="border-left: 4px solid #00eaff;">‚≠ê M√ÅS VENDIDOS</div>
                <table class="table-dark">
                    {% for p in top_productos %}
                    <tr>
                        <td>{{ p.producto__nombre }}</td>
                        <td style="text-align:right; font-weight:bold; color:#00eaff;">{{ p.total_vendido }}</td>
                    </tr>
                    {% empty %}<tr><td colspan="2" class="text-center p-3">Sin datos</td></tr>{% endfor %}
                </table>
            </div>
        </div>
    </div>

</div>

<div id="modal-apertura" class="modal-overlay">
    <div class="modal-box" style="border: 2px solid #ccff00;">
        <h2 style="color:#ccff00;">ABRIR CAJA</h2>
        <form action="{% url 'admin:venta_abrir_caja' %}" method="POST">
            {% csrf_token %}
            <input type="number" name="monto" placeholder="Fondo Inicial ($)" step="0.01" required>
            <button type="submit" class="btn-custom btn-green" style="width:100%;">INICIAR TURNO</button>
        </form>
        <button onclick="document.getElementById('modal-apertura').style.display='none'" style="margin-top:15px; background:none; border:none; color:#666; cursor:pointer;">Cancelar</button>
    </div>
</div>

<div id="modal-gasto" class="modal-overlay">
    <div class="modal-box" style="border: 2px solid #ff4d4d;">
        <h2 style="color:#ff4d4d;">NUEVO GASTO</h2>
        <form action="{% url 'admin:venta_nuevo_gasto' %}" method="POST">
            {% csrf_token %}
            <input type="text" name="concepto" placeholder="¬øQu√© se pag√≥?" required>
            <input type="number" name="monto" placeholder="Monto ($)" step="0.01" required>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button type="button" onclick="document.getElementById('modal-gasto').style.display='none'" class="btn-custom" style="background:#333; color:#ccc; width:50%;">CANCELAR</button>
                <button type="submit" class="btn-custom btn-red" style="width:50%;">GUARDAR</button>
            </div>
        </form>
    </div>
</div>

<script>
    var ctx = document.getElementById('ventasChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ chart_labels|safe }},
            datasets: [{ 
                label: 'Ventas ($)', 
                data: {{ chart_data|safe }}, 
                borderColor: '#ccff00', 
                backgroundColor: 'rgba(204, 255, 0, 0.1)',
                fill: true,
                tension: 0.4 
            }]
        },
        options: { 
            maintainAspectRatio: false, 
            plugins: { legend: { display: false } },
            scales: { x: { grid: { display: false } }, y: { grid: { color: '#333' } } }
        }
    });
</script>
{% endblock %}